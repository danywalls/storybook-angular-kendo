import { strings } from '@angular-devkit/core';
import {
	apply,
	chain,
	externalSchematic,
	MergeStrategy,
	mergeWith,
	move,
	Rule,
	SchematicContext,
	template,
	Tree,
	url
} from '@angular-devkit/schematics';

import { basename, normalize, dirname, win32 } from 'path';
import { Schema } from './schema';
import { products } from './files/data';

export function grid(_options: Schema): Rule {
	return (_tree: Tree, _context: SchematicContext) => {
		_options.name = basename(_options.name);

		let path =  normalize('/' + dirname((_options.path + '/' + _options.name)));
		if (process.platform == "win32") {
			path = path.replace(/\\/g, '/');
		}

		const templateSource = apply(
			url(_options.inlineTemplate ? './files/inline' : './files/html'), [
				template({
					..._options,
					classify: strings.classify,
					dasherize: strings.dasherize,
					arrayify(args: string[]) {
						return args.map(s => `'${s}'`).join(", ");
					}
				}),
				move(_options.path),
			],
		);

        const angularComponentOptions = {
			path: _options.path,
			name: _options.name,
			inlineTemplate: _options.inlineTemplate,
			inlineStyle: _options.inlineStyle,
			skipTests: _options.skipTests
		};

		if(_options.mockedData) {
			_tree.create(`${_options.path}/${_options.name}/data.ts`, `export const products = ${products}`);
		}

		return chain([
			externalSchematic('@schematics/angular', 'component', angularComponentOptions),
			mergeWith(templateSource, MergeStrategy.Overwrite)
		]);
	};
}
